# =============================================================================
# INFOTEC - Configuración Automática de Laravel con Docker Compose
# =============================================================================
# PROPÓSITO: Crear y ejecutar Laravel automáticamente con UN SOLO COMANDO
# USO: docker compose up -d
# RESULTADO: Laravel ejecutándose en http://localhost:8000
# =============================================================================

services:
  # ============================================
  # BASE DE DATOS MARIADB
  # ============================================
  mariadb:
    image: bitnami/mariadb:11.4
    container_name: infotec_mariadb
    environment:
      - ALLOW_EMPTY_PASSWORD=no
      - MARIADB_ROOT_PASSWORD=${MARIADB_ROOT_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      - MARIADB_CHARACTER_SET=utf8mb4
      - MARIADB_COLLATE=utf8mb4_unicode_ci
    volumes:
      - mariadb_data:/bitnami/mariadb
    restart: unless-stopped
    networks:
      - laravel-network
    ports:
      - "127.0.0.1:3306:3306"
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost", "-u", "${MARIADB_USER}", "-p${MARIADB_PASSWORD}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    security_opt:
      - no-new-privileges:true

  # ============================================
  # APLICACIÓN LARAVEL CON CREACIÓN AUTOMÁTICA
  # ============================================
  laravel:
    image: bitnami/laravel:11
    container_name: infotec_laravel
    environment:
      - LARAVEL_DATABASE_TYPE=mysql
      - LARAVEL_DATABASE_HOST=mariadb
      - LARAVEL_DATABASE_PORT_NUMBER=3306
      - LARAVEL_DATABASE_NAME=${MARIADB_DATABASE}
      - LARAVEL_DATABASE_USER=${MARIADB_USER}
      - LARAVEL_DATABASE_PASSWORD=${MARIADB_PASSWORD}
      - LARAVEL_VERSION=${LARAVEL_VERSION:-11.*}
      - PHP_MEMORY_LIMIT=256M
      - PHP_MAX_EXECUTION_TIME=300
    ports:
      - "8000:8000"
    volumes:
      - ./src:/app
      - vendor_data:/app/vendor
      - composer_cache:/root/.composer/cache
    command: >
      bash -c "
        echo '🚀 INFOTEC - Configuración automática de Laravel'
        
        # Esperar MariaDB
        echo '⏳ Esperando MariaDB...'
        for i in {1..30}; do
          if mysqladmin ping -h mariadb -u \$$LARAVEL_DATABASE_USER -p\$$LARAVEL_DATABASE_PASSWORD --silent 2>/dev/null; then
            echo '✅ MariaDB conectado'
            break
          fi
          sleep 2
        done
        
        cd /app
        
        # Crear Laravel si no existe
        if [ ! -f artisan ] && [ ! -f composer.json ]; then
          echo '📁 Creando nuevo proyecto Laravel...'
          
          # Preservar .gitignore personalizado
          [ -f .gitignore ] && cp .gitignore /tmp/custom-gitignore
          
          # Crear proyecto Laravel
          composer create-project laravel/laravel:\$$LARAVEL_VERSION /tmp/laravel --prefer-dist --no-interaction
          cp -r /tmp/laravel/. . && rm -rf /tmp/laravel
          
          # Restaurar .gitignore personalizado
          [ -f /tmp/custom-gitignore ] && cp /tmp/custom-gitignore .gitignore
          
          echo '✅ Laravel creado exitosamente'
        fi
        
        # Instalar dependencias
        [ ! -d vendor ] || [ ! -f vendor/autoload.php ] && composer install --no-interaction --optimize-autoloader
        
        # Configurar Laravel
        [ ! -f .env ] && cp .env.example .env
        
        # Configurar base de datos
        sed -i 's/DB_CONNECTION=.*/DB_CONNECTION=mysql/' .env
        sed -i 's/DB_HOST=.*/DB_HOST=mariadb/' .env
        sed -i 's/DB_PORT=.*/DB_PORT=3306/' .env
        sed -i \"s/DB_DATABASE=.*/DB_DATABASE=\$$LARAVEL_DATABASE_NAME/\" .env
        sed -i \"s/DB_USERNAME=.*/DB_USERNAME=\$$LARAVEL_DATABASE_USER/\" .env
        sed -i \"s/DB_PASSWORD=.*/DB_PASSWORD=\$$LARAVEL_DATABASE_PASSWORD/\" .env
        
        # Generar APP_KEY si no existe
        grep -q 'APP_KEY=base64:' .env || php artisan key:generate --force
        
        # Migrar base de datos
        php artisan migrate --force
        
        # Configurar permisos
        chmod -R 775 storage bootstrap/cache 2>/dev/null || true
        
        echo '🎉 Laravel listo en http://localhost:8000'
        
        # Iniciar servidor
        exec php artisan serve --host=0.0.0.0 --port=8000
      "
    depends_on:
      mariadb:
        condition: service_healthy
    restart: unless-stopped
    networks:
      - laravel-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s


# =============================================================================
# VOLÚMENES PERSISTENTES
# =============================================================================
volumes:
  mariadb_data:
    driver: local
    # Persistencia de datos de MariaDB (volumen Docker gestionado)
  
  vendor_data:
    driver: local
    # Carpeta vendor de Composer para rendimiento (ESENCIAL en Windows)
    
  composer_cache:
    driver: local
    # Cache de Composer para acelerar instalaciones

# =============================================================================
# RED INTERNA
# =============================================================================
networks:
  laravel-network:
    driver: bridge
    # Red interna para comunicación entre contenedores
    